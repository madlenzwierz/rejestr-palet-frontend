<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<!-- Tu ogarniam zmianƒô wersji na telefonie, zeby nie wyswietla≈Ça siƒô stara wersja -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<!-- koniec --> 
 
<title>Rejestr lokalizacji palet</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  font-family:system-ui,sans-serif;
  margin:0;
  padding:12px;
  background:#fafafa;
  overflow-x:hidden;
}

button{
  border:none;
  border-radius:10px;
  padding:14px;
  font-size:16px;
  background:#444;
  color:#fff;
}
button.active{background:#111}
.section{
  margin-bottom:28px;
}

/* START */

#location-screen{
  display:flex;
  flex-direction:column;
  gap:30px;
  align-items:center;
  padding-top:40px;
}
.location-btn{
  width:80%;
  max-width:420px;
  height:120px;
  font-size:28px;
  font-weight:bold;
}
.druk{background:#ffe066;color:#000}
.gut{background:#e0e0e0;color:#000}

/* APP */
.app-container{
  max-width:480px;
  margin:0 auto;
  padding-bottom:40px;
  display:flex;
  flex-direction:column;
}

/* SCAN */
.scan-buttons{
  display:flex;
  gap:20px;
  margin-top:30px;
  margin-bottom:30px;
}
.scan-buttons button{flex:1;height:60px}
.scan-buttons .order{background:#ffe066;color:#000}
.scan-buttons .machine{background:#e0e0e0;color:#000}

.camera-wrapper{
  width:100%;
  max-width:420px;
  height:60vw;              /* wysoko≈õƒá zale≈ºna od szeroko≈õci ekranu */
  max-height:420px;         /* limit na du≈ºych ekranach */
  margin:15px auto;
  border:2px solid #aaa;
  border-radius:12px;
  overflow:hidden;
  background:#000;
}

#qr-reader{
  width:100%;
  height:100%;
}

#qr-reader video{
  width:100%!important;
  height:100%!important;
  object-fit:cover;
}

.scan-info div{margin:6px 0;font-weight:bold}

/* PRZYPISZ */
.assign-btn{
  height:60px;
  font-size:20px;
  background:#ffe066;
  color:#000;
}
#info{
  margin-top:8px;
  margin-bottom:16px;
  padding:10px;
  background:#dff0d8;
  border-radius:8px;
  font-weight:bold;
}

/* OBSZARY */
.zone-buttons{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
}
.zone-buttons button:last-child{grid-column:span 4}
button.highlight-zone{outline:4px solid orange}

/* MAPA */
.map-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.grid{display:flex;gap:8px}
.column{display:flex;flex-direction:column;gap:8px}
.column-header{text-align:center;font-weight:bold}

/* POLA */
.cell{
  min-width:48px;
  padding:12px;
  background:#eee;
  border-radius:8px;
  border:1px solid #aaa;
  text-align:center;
}
.cell.pending{background:#ddd;outline:3px solid #aaa}
.cell.occupied{
  background:#999;
  color:#222;
  font-weight:bold;
  cursor:not-allowed;
}
.cell.highlight{background:orange!important}

/* MASZYNY */
.machine-row{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:32px;
}
.machine{
  min-height:48px;
  padding:14px 18px;
  background:#eee;
  border-radius:10px;
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
}
.machine.highlight{outline:4px solid orange}

.machine.pending{
  background:#ddd;
  outline:3px solid #aaa;
}

.machine.occupied{
  background:#999;
  color:#222;
  font-weight:bold;
  cursor:not-allowed;
}

/* SEARCH */
input{
  width:100%;
  padding:12px;
  font-size:16px;
  margin-bottom:14px;
}
.search-buttons{display:flex;gap:10px;margin-top:4px}
#search-results{
  margin-top:12px;
  padding:10px;
  background:#f0f0f0;
  border-radius:8px;
  font-size:14px;
}
#search-results div{
  padding:6px 0;
  border-bottom:1px solid #ccc;
}
#search-results div:last-child{border-bottom:none}

/* ===== GLOBAL SEARCH (START SCREEN) ===== */

#globalSearchInput{
  width:80%;
  max-width:420px;
  padding:14px;
  font-size:16px;
  border-radius:10px;
  border:1px solid #aaa;
  margin-bottom:12px;
}

#global-search-results{
  width:80%;
  max-width:420px;
  background:#f0f0f0;
  border-radius:8px;
  padding:8px 12px;
  font-size:14px;
  margin-bottom:20px;
}

#global-search-results div{
  padding:6px 0;
  border-bottom:1px solid #ccc;
}

#global-search-results div:last-child{
  border-bottom:none;
}

/* ===== DRUKARSKA ‚Äì GRID STREF ===== */
.drukarska-grid{
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 18px;
  margin-top: 12px;
}

/* Kafelki stref */
.drukarska-grid .cell{
  min-height: 96px;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Kafel MASZYNY ‚Äì pe≈Çna szeroko≈õƒá */
.drukarska-grid .machines-tile{
  grid-column: span 2;
  background: #111;
  color: #fff;
  font-weight: bold;
}

/* ===== DRUKARSKA ‚Äì GRID MASZYN ===== */
.drukarska-machines-grid{
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 18px;
  margin-top: 18px;
}

.drukarska-machines-grid .machine{
  min-height: 96px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}

.app-footer{
  margin-top:40px;
  padding:16px 8px;
  text-align:center;
  font-size:12px;
  color:#666;
  border-top:1px solid #ddd;
}

button{
  transition:0.15s;
}

button:hover{
  transform:scale(1.03);
}

input, select{
  border-radius:10px;
  border:1px solid #bbb;
}

@media (max-width: 600px){

  .app-container{
    padding-top: 0px;
  }

  .scan-buttons{
    margin-top: 10px;
    margin-bottom: 10px;
  }

  .camera-wrapper{
    margin-top: 10px;
  }

  body{
    padding-top: 5px;
  }

}

</style>
</head>

<body>

<div
  id="top-auth-bar"
  style="
    display:none;
    width:100%;
    max-width:480px;
    margin:0 auto 16px;
  "
>
  <button
    onclick="logout()"
    style="width:100%;background:#c0392b"
  >
    ‚èª Wyloguj
  </button>
</div>

<!-- üëë WEJ≈öCIE DO PANELU ADMINISTRATORA -->
<div
  id="admin-entry"
  style="
    display:none;
    width:100%;
    max-width:480px;
    margin:0 auto 16px;
  "
>
  <button
    onclick="toggleAdminPanel()"
    style="width:100%;background:#222"
  >
    üëë Panel administratora
  </button>
</div>

<!-- üîê PANEL ADMINISTRATORA (ZAWARTO≈öƒÜ) -->
<div
  id="admin-panel"
  style="
    display:none;
    width:100%;
    max-width:480px;
    margin:0 auto 24px;
    padding:16px;
    background:#f3f3f3;
    border-radius:14px;
    box-shadow:0 2px 8px rgba(0,0,0,.08)
  "
>
  <h2 style="margin-top:0">üëë Panel administratora</h2>

  <button onclick="toggleUsersList()">üë• Poka≈º u≈ºytkownik√≥w</button>

  <hr>

  <h3>‚ûï Dodaj u≈ºytkownika</h3>

  <input id="newUserLogin" placeholder="Login">

  <input id="newUserPass" type="password" placeholder="Has≈Ço">

  <select id="newUserRole">
    <option value="pracownik">Pracownik</option>
    <option value="operator">Operator</option>
    <option value="operator_kolbus">Operator KOLBUS</option>
    <option value="operator_da">Operator DA</option>
    <option value="operator_diamant">Operator DIAMANT</option>
    <option value="mleczarz">Mleczarz</option>
    <option value="magazynier">Magazynier</option>
    <option value="kierowca">Kierowca</option>
  </select>

  <button onclick="adminCreateUser()">‚ûï Dodaj u≈ºytkownika</button>

  <div id="admin-msg" style="margin-top:8px;font-weight:bold"></div> 

  <div
    id="admin-users-list"
    style="
      margin-top:12px;
      background:#fff;
      border-radius:10px;
      padding:12px;
      display:none;
    "
  ></div>
</div>

<hr style="max-width:480px;margin:0 auto 32px;border:none;border-top:1px solid #ddd">

<div id="login-screen" style="display:flex;flex-direction:column;align-items:center;gap:16px;margin-top:80px">
  <h2>Logowanie</h2>

  <input
    id="loginUser"
    placeholder="Symbol pracownika"
    style="max-width:300px"
  >

  <input
    id="loginPass"
    type="password"
    placeholder="Has≈Ço"
    style="max-width:300px"
  >

  <button onclick="handleLogin()" style="width:300px">
    Zaloguj
  </button>

  <div id="login-error" style="color:red;font-weight:bold"></div>
</div>

<div id="location-screen">
  <h1>Rejestr lokalizacji palet</h1>

  <input
    id="globalSearchInput"
    placeholder="Szukaj zlecenia / rodziny (globalnie)"
    oninput="globalSearch()"
  />

  <button onclick="clearGlobalSearch()">Wyczy≈õƒá</button>

  <div id="global-search-results"></div>
  
  <!-- üìç WYB√ìR LOKALIZACJI -->
  <button class="location-btn druk" onclick="startApp('DRUKARSKA')">DRUKARSKA</button>
  <button class="location-btn gut" onclick="startApp('GUTENBERGA')">GUTENBERGA</button>
  <button class="location-btn druk" onclick="startApp('TRANSPORT')">W TRANSPORCIE</button>
</div>

<!-- ‚öôÔ∏è STAN PROCESU ‚Äì ROZWIJANY -->
<div 
  id="process-wrapper"
  style="max-width:480px;margin:16px auto;display:none"
>

  <button 
    onclick="toggleProcessPanel()" 
    style="width:100%;background:#2c3e50"
  >
    ‚öôÔ∏è Stan procesu
  </button>

  <div 
    id="process-panel" 
    style="
      display:none;
      margin-top:12px;
      padding:18px;
      background:#eef2ff;
      border-radius:14px;
    "
  >
    <input
      id="processOrder"
      placeholder="Numer zlecenia (np. 25/4444)"
      style="margin-bottom:14px"
    >

    <select 
      id="processStatus"
      style="
        width:100%;
        padding:14px;
        font-size:16px;
        margin-bottom:14px;
      "
    >
      <option value="0">0 ‚Äì Przed procesem</option>
      <option value="1">1 ‚Äì W trakcie</option>
      <option value="2">2 ‚Äì Proces zako≈Ñczony</option>
      <option value="3">3 ‚Äì Niezgodno≈õƒá</option>
    </select>

    <div style="display:flex;gap:12px;margin-bottom:12px">
      <button 
        onclick="confirmProcessStatus()" 
        style="flex:1"
      >
        Zapisz stan
      </button>

      <button 
        onclick="manualRemoveFromMachine()" 
        style="flex:1;background:#c0392b"
      >
        Wyprowad≈∫ z maszyny
      </button>
    </div>
  </div>
</div>

<div id="app" style="display:none">
<button onclick="goBack()" style="margin-bottom:12px">‚Üê Powr√≥t</button>

<div class="app-container">

<div class="section scan-buttons">
  <button class="order" onclick="scanOrder()">Skanuj zlecenie</button>
  <button class="machine" onclick="scanMachine()">Skanuj maszynƒô</button>
</div>

<div class="section">
  <input
    id="manualOrderInput"
    placeholder="Wpisz numer zlecenia (np. 26/0001-WYK)"
  >
  <button onclick="setManualOrder()">Ustaw zlecenie</button>
</div>

<div class="camera-wrapper"><div id="qr-reader"></div></div>

<div class="scan-info section">
  <div>Zeskanowane zlecenie: <span id="current-order">‚Äì</span></div>
  <div>Zeskanowana maszyna: <span id="current-machine">‚Äì</span></div>
</div>

<div class="section" style="display:flex; gap:12px">
  <button class="assign-btn" onclick="assignLocation()">PRZYPISZ</button>
  <button class="assign-btn" style="background:#e0e0e0;color:#000" onclick="clearScan()">WYCZY≈öƒÜ</button>
</div>
<div id="info"></div>

<div class="zone-buttons section">
  <button onclick="switchZone('A',this)">A</button>
  <button onclick="switchZone('B',this)">B</button>
  <button onclick="switchZone('C',this)">C</button>
  <button onclick="switchZone('D',this)">D</button>
  <button onclick="switchZone('E',this)">E</button>
  <button onclick="switchZone('F',this)">F</button>
  <button onclick="switchZone('G',this)">G</button>
  <button onclick="switchZone('H',this)">H</button>
  <button onclick="switchZone('MASZYNA',this)">MASZYNY</button>
</div>

<div class="map-scroll section">
  <div id="dynamic-grid-container"></div>
</div>

<div class="section">
  <input id="searchInput" placeholder="Szukaj zlecenia / rodziny">
  <div class="search-buttons">
    <button onclick="searchOrder()">Szukaj</button>
    <button onclick="clearSearch()">Wyczy≈õƒá</button>
  </div>
  <div id="search-results"></div>
</div>

<div class="section">
  <button onclick="downloadHistoryCSV()">
    üìä Eksport historii (CSV)
  </button>
</div>

</div>
</div>

<footer class="app-footer">
  ¬© 2026 Magdalena Zwierzchaczewska<br>
  Wszelkie prawa zastrze≈ºone.<br>
  <strong>Wersja testowa.</strong>
</footer>

<script>

// =====================
// AUTORYZACJA / STAN
// =====================

let currentUser = null; // { id, username }
const API_URL = "https://rejestr-palet-backend.onrender.com"; // serwer

let currentOrder = null;
let currentMachine = null;
let selectedCell = null;

let assigned = {};
let currentZone = "A";

let highlightedCells = [];
let highlightedMachines = [];
let highlightedZones = [];

let currentLocation = null; // DRUKARSKA | GUTENBERGA | TRANSPORT
let drukarskaView = "STREFY"; 

// =====================
// SKANOWANIE (ETAP 1 ‚Äì MINIMUM)
// =====================

function scanOrder(){
  const reader = document.getElementById("qr-reader");
  reader.innerHTML = "";

  const html5QrCode = new Html5Qrcode("qr-reader");

  html5QrCode.start(
    { facingMode: "environment" },
    {
      fps: 10,
      qrbox: function(viewfinderWidth, viewfinderHeight) {
        const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
        return {
          width: minEdge * 0.7,
          height: minEdge * 0.7
        };
      }
    },
    (decodedText) => {
      // üîë QR zawiera tylko numer zlecenia / rodzinƒô
      currentOrder = decodedText.trim();

      document.getElementById("current-order").textContent = currentOrder;

      console.log("üì¶ Zeskanowano zlecenie:", currentOrder);

      html5QrCode.stop().then(() => {
        reader.innerHTML = "";
      });
    },
    (errorMessage) => {
      // ignorujemy b≈Çƒôdy skanowania
    }
  ).catch(err => {
    alert("Nie uda≈Ço siƒô uruchomiƒá kamery");
    console.error(err);
  });
}

function scanMachine(){
  const reader = document.getElementById("qr-reader");
  reader.innerHTML = "";

  const html5QrCode = new Html5Qrcode("qr-reader");

  html5QrCode.start(
    { facingMode: "environment" },
    {
      fps: 10,
      qrbox: function(viewfinderWidth, viewfinderHeight) {
        const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
        return {
          width: minEdge * 0.7,
          height: minEdge * 0.7
        };
      }
    },
    (decodedText) => {

      const scanned = decodedText.trim();

      selectedCell = scanned;
      currentMachine = scanned;

      document.getElementById("current-machine").textContent =
        scanned.replace("MASZYNA-", "");

      console.log("üìç Zeskanowano lokalizacjƒô:", scanned);

      html5QrCode.stop().then(() => {
        reader.innerHTML = "";
      });

      renderGrid();
    },
    (errorMessage) => {}
  ).catch(err => {
    alert("Nie uda≈Ço siƒô uruchomiƒá kamery");
    console.error(err);
  });
}

function setManualOrder(){
  const input = document.getElementById("manualOrderInput");
  const value = input.value.trim();

  if(!value){
    alert("Wpisz numer zlecenia");
    return;
  }

  currentOrder = value;
  document.getElementById("current-order").textContent = value;

  console.log("üì¶ Ustawiono zlecenie rƒôcznie:", value);

  input.value = "";
}

// =====================
// POMOCNICZE
// =====================

function getFamily(order){
  if(!order) return null;
  return order.split("-")[0];
}

function canAssignToGridCell(cellKey, order){
  const family = getFamily(order);

  const existing = Object.entries(assigned)
    .filter(([_,a]) =>
      a.location === "GUTENBERGA" &&
      a.place === cellKey
    );

  if(existing.length === 0) return true;

  const existingFamily = getFamily(existing[0][0]);
  return existingFamily === family;
}

function goBack(){
  document.getElementById("app").style.display = "none";
  document.getElementById("location-screen").style.display = "flex";

  // reset globalny
  currentLocation = null;
  currentZone = "A";
  drukarskaView = "STREFY";

  highlightedCells = [];
  highlightedMachines = [];
  highlightedZones = [];

  document.getElementById("dynamic-grid-container").innerHTML = "";
  // ukryj panel procesu po powrocie na ekran g≈Ç√≥wny
  document.getElementById("process-wrapper").style.display = "none";
}

// =====================
// HISTORIA (JEDNA WERSJA)
// =====================

async function loadHistory(){
  try{
    const res = await fetch(`${API_URL}/api/history`);
    const rows = await res.json();

    assigned = {};

    rows.forEach(r => {
      if(r.action !== "ASSIGN") return;

      // BACKEND JEST ≈πR√ìD≈ÅEM PRAWDY
      // r.location to np:
      // "DRUKARSKA / Magazyn parter"
      // "MASZYNA-Tƒôczowa"
      // "A1-1"

      if(r.location.includes(" / ")){
        const [loc, place] = r.location.split(" / ");
        assigned[r.order_id] = {
          location: loc,   // DRUKARSKA
          place: place     // Magazyn parter
        };
        return;
      }

      if(r.location.startsWith("MASZYNA-")){
        assigned[r.order_id] = {
          location: "MASZYNA",
          place: r.location
        };
        return;
      }

      // GRID (GUTENBERGA)
      assigned[r.order_id] = {
        location: "GUTENBERGA",
        place: r.location
      };
    });

    console.log("‚ôªÔ∏è Odtworzony stan assigned:", assigned);

  }catch(err){
    console.error("‚ùå B≈ÇƒÖd ≈Çadowania historii:", err);
  }
}

// =====================
// LOKALIZACJE
// =====================

const LOCATIONS = {
  GUTENBERGA: {
    type: "GRID",
    zones: {
      A:{cols:13,rows:8},
      B:{cols:5,rows:7},
      C:{cols:7,rows:16},
      D:{cols:2,rows:9},
      E:{cols:26,rows:6},
      F:{cols:22,rows:9},
      G:{cols:6,rows:4},
      H:{cols:6,rows:4}
    },
    machines: [
      ["OGR√ìDEK","SPEDYCJA"],
      ["Lawendowa","Fioletowa","Lazurowa","Bia≈Ça","Szara","Tƒôczowa"],
      ["Timson","Antracytowa","Pomara≈Ñczowa"],
      ["Delta","Sagitta","Sakurai 1","Sakurai 2","MGI","Yoco 1","Yoco 2"],
      ["S2","S6","S3","S4"],
      ["Kolbus B","Kolbus E","Kolbus D"]
    ]
  },

  DRUKARSKA: {
    type: "LIST",
    zones: [
      "Magazyn parter",
      "Ko≈õci√≥≈Ç",
      "Tektura ok≈Çadka",
      "Oklejki",
      "Ok≈Çadki",
      "Bloki",
      "Wyr√≥b niezgodny"
    ],
    machines: [
      ["Tƒôczowa"],
      ["S5","S9"],
      ["PK1","PK2","DA 260","DA 270","Diamant","BF 512"]
    ]
  },
  

  TRANSPORT: { type: "TRANSPORT" }
};

// =====================
// TEKTURA OK≈ÅADKA ‚Äì KONFIGURACJA
// =====================

const TEKTURA_CFG = {
  rows: [
    ["A", "B"],
    ["C", "D"],
    ["E", "F"],
    ["G", "H"]
  ],
  slotsPerRow: 15
};

function rebuildHighlightsForCurrentLocation(){
  highlightedCells = [];
  highlightedMachines = [];
  highlightedZones = [];

  Object.values(assigned).forEach(a => {
    if(!isOrderInCurrentLocation(a)) return;

    // MASZYNY
    if(a.place.startsWith("MASZYNA-")){
      const name = a.place.replace("MASZYNA-", "");
      if(!highlightedMachines.includes(name)){
        highlightedMachines.push(name);
      }
      if(!highlightedZones.includes("MASZYNA")){
        highlightedZones.push("MASZYNA");
      }
      return;
    }

    // GRID / STREFY
    highlightedCells.push(a.place);

    const zone = a.place[0];
    if(zone && !highlightedZones.includes(zone)){
      highlightedZones.push(zone);
    }
  });

  console.log("üéØ Pod≈õwietlenia:", {
    cells: highlightedCells,
    machines: highlightedMachines,
    zones: highlightedZones
  });
}

// =====================
// START APLIKACJI
// =====================

function startApp(location){

  if(!currentUser){
    alert("üîí Musisz siƒô zalogowaƒá");
    return;
  }

  currentLocation = location;

  // poka≈º panel procesu dopiero po wej≈õciu do lokalizacji
  document.getElementById("process-wrapper").style.display = "block";

  // zawsze startujemy ze ZWINIƒòTYM panelem
  document.getElementById("process-panel").style.display = "none";

  document.getElementById("location-screen").style.display = "none";
  document.getElementById("app").style.display = "block";

  selectedCell = null;
  highlightedCells = [];
  highlightedMachines = [];
  highlightedZones = [];

  if(location === "DRUKARSKA"){
    drukarskaView = "STREFY";
  }

  const zoneButtons = document.querySelectorAll(".zone-buttons button");
  zoneButtons.forEach(b => {
    b.style.display = location === "GUTENBERGA" ? "block" : "none";
    b.classList.remove("active","highlight-zone");
  });

  const cfg = LOCATIONS[location];
  currentZone = cfg.type === "GRID" ? "A" : null;

  loadHistory().then(() => {
    rebuildHighlightsForCurrentLocation();
    renderGrid();
  });
}

function switchZone(z, btn){
  currentZone = z;

  // reset zaznaczenia
  selectedCell = null;

  document
    .querySelectorAll(".zone-buttons button")
    .forEach(b => b.classList.remove("active","highlight-zone"));

  btn.classList.add("active");

  renderGrid();
}

// =====================
// RENDER
// =====================

function isOrderInCurrentLocation(a){
  if(!currentLocation) return false;
  return a.location === currentLocation;
}

function renderGrid(){
  if(!currentLocation) return;

  const c = document.getElementById("dynamic-grid-container");
  c.innerHTML = "";

  const cfg = LOCATIONS[currentLocation];

  /* ================= TRANSPORT ================= */
  if(cfg.type === "TRANSPORT"){
    Object.entries(assigned)
      .filter(([_,a]) => a.location === "TRANSPORT")
      .forEach(([o])=>{
        const d = document.createElement("div");
        d.className = "cell";
        d.textContent = o;
        c.appendChild(d);
      });
    return;
  }

  /* ================= DRUKARSKA ‚Äì STREFY ================= */
  if(cfg.type === "LIST" && drukarskaView === "STREFY"){
    const grid = document.createElement("div");
    grid.className = "drukarska-grid";

    // kafel MASZYNY
    const machinesBtn = document.createElement("div");
    machinesBtn.className = "cell machines-tile";
    machinesBtn.textContent = "MASZYNY";
    machinesBtn.onclick = () => {
      drukarskaView = "MASZYNY";
      renderGrid();
    };
    grid.appendChild(machinesBtn);

    // strefy
    cfg.zones.forEach(z=>{
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.textContent = z;

      if(selectedCell === z){
        cell.classList.add("pending");
      }

      const occupied = Object.values(assigned)
        .some(a => isOrderInCurrentLocation(a) && a.place === z);

      if(occupied){
        cell.classList.add("occupied");
      }

      cell.onclick = () => {

        // SPECJALNY WIDOK TEKTURY
        if(z === "Tektura ok≈Çadka"){
          drukarskaView = "TEKTURA_GRID";
          selectedCell = null;
          renderGrid();
          return;
        }

        // TRYB PRZYPISANIA (reszta bez zmian)
        if(currentOrder){
          selectedCell = z;
          renderGrid();
          return;
        }

        // PODGLƒÑD
        const list = Object.entries(assigned)
          .filter(([_,a]) =>
            isOrderInCurrentLocation(a) && a.place === z
          )
          .map(([o]) => o);

        alert(
          list.length
            ? `Zlecenia w strefie "${z}":\n\n${list.join("\n")}`
            : `Brak zlece≈Ñ w strefie "${z}"`
        );
      };

      grid.appendChild(cell);
    });

    c.appendChild(grid);
    return;
  }
  
  /* ================= DRUKARSKA ‚Äì TEKTURA OK≈ÅADKA (GRID jak Gutenberg) ================= */
  if(cfg.type === "LIST" && drukarskaView === "TEKTURA_GRID"){
    const wrapper = document.createElement("div");
    wrapper.style.display = "flex";
    wrapper.style.gap = "32px";          // ‚¨ÖÔ∏è PRZERWA MIƒòDZY AB / CD / EF / GH
    wrapper.style.overflowX = "auto";    // poziomy scroll
    wrapper.style.paddingBottom = "12px";

    // POWR√ìT
    const back = document.createElement("div");
    back.className = "cell";
    back.textContent = "‚Üê STREFY";
    back.style.minWidth = "120px";
    back.onclick = () => {
      drukarskaView = "STREFY";
      renderGrid();
    };
    c.appendChild(back);

    TEKTURA_CFG.rows.forEach(group => {
      const groupWrap = document.createElement("div");
      groupWrap.style.display = "flex";
      groupWrap.style.gap = "12px"; // A | B blisko siebie

      group.forEach(letter => {
        const col = document.createElement("div");
        col.style.display = "flex";
        col.style.flexDirection = "column";
        col.style.gap = "8px";

        const header = document.createElement("div");
        header.textContent = letter;
        header.className = "column-header";
        col.appendChild(header);

        for(let i=1; i<=TEKTURA_CFG.slotsPerRow; i++){
          const key = `TEKTURA-${letter}${i}`;
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.textContent = i;

          const occupied = Object.values(assigned)
            .some(a =>
              a.location === "DRUKARSKA" &&
              a.place === key
            );

          if(occupied) cell.classList.add("occupied");
          if(selectedCell === key) cell.classList.add("pending");

          cell.onclick = () => {
            if(currentOrder && !occupied){
              selectedCell = key;
              renderGrid();
              return;
            }

            const list = Object.entries(assigned)
              .filter(([_,a]) =>
                a.location === "DRUKARSKA" && a.place === key
              )
              .map(([o]) => o);

            alert(
              list.length
                ? `Zlecenia na palecie ${key}:\n\n${list.join("\n")}`
                : `Brak zlece≈Ñ`
            );
          };

          col.appendChild(cell);
        }

        groupWrap.appendChild(col);
      });

      wrapper.appendChild(groupWrap);
    });

    c.appendChild(wrapper);
    return;
  }

  /* ================= DRUKARSKA ‚Äì MASZYNY ================= */
  if(cfg.type === "LIST" && drukarskaView === "MASZYNY"){
    const grid = document.createElement("div");
    grid.className = "drukarska-machines-grid";

    const back = document.createElement("div");
    back.className = "cell";
    back.textContent = "‚Üê STREFY";
    back.style.fontWeight = "bold";
    back.onclick = () => {
      drukarskaView = "STREFY";
      renderGrid();
    };
    grid.appendChild(back);

    cfg.machines.flat().forEach(name=>{
      const m = document.createElement("div");
      m.className = "machine";
      m.textContent = name;

      const occupied = Object.values(assigned)
        .some(a =>
          typeof a.place === "string" &&
          a.place.startsWith("MASZYNA-") &&
          a.place.endsWith(name)
        );

      if(occupied){
        m.classList.add("occupied");
      }

      if(selectedCell === "MASZYNA-" + name){
        m.classList.add("pending");
      }

      m.onclick = () => {

        // TRYB PRZYPISANIA
        if(currentOrder){
          selectedCell = "MASZYNA-" + name;
          renderGrid();
          return;
        }

        // PODGLƒÑD
        const list = Object.entries(assigned)
          .filter(([_,a]) =>
            a.place === "MASZYNA-" + name
          )
          .map(([o]) => o);

        alert(
          list.length
            ? `Zlecenia na maszynie ${name}:\n\n${list.join("\n")}`
            : `Brak zlece≈Ñ`
        );
      };

      grid.appendChild(m);
    });

    c.appendChild(grid);
    return;
  }

  /* ================= GUTENBERGA ‚Äì MASZYNY ================= */
  if(cfg.type === "GRID" && currentZone === "MASZYNA"){
    cfg.machines.forEach(row=>{
      const r = document.createElement("div");
      r.className = "machine-row";

      row.forEach(name=>{
        const m = document.createElement("div");
        m.className = "machine";
        m.textContent = name;

        if(selectedCell === "MASZYNA-" + name){
          m.classList.add("pending");
        }

        m.onclick = () => {

          // TRYB PRZYPISANIA
          if(currentOrder){
            selectedCell = "MASZYNA-" + name;
            renderGrid();
            return;
          }

          // PODGLƒÑD
          const list = Object.entries(assigned)
            .filter(([_,a]) =>
              isOrderInCurrentLocation(a) &&
              a.place === "MASZYNA-" + name
            )
            .map(([o]) => o);

          alert(
            list.length
              ? `Zlecenia przypisane do maszyny ${name}:\n\n${list.join("\n")}`
              : `Brak zlece≈Ñ`
          );
        };

        r.appendChild(m);
      });

      c.appendChild(r);
    });

    return;
  }

  /* ================= GUTENBERGA ‚Äì POLA ================= */
  const zoneCfg = cfg.zones[currentZone];
  if(!zoneCfg) return;

  const g = document.createElement("div");
  g.className = "grid";

  for(let col=1; col<=zoneCfg.cols; col++){
    const cd = document.createElement("div");
    cd.className = "column";

    const h = document.createElement("div");
    h.className = "column-header";
    h.textContent = currentZone + col;
    cd.appendChild(h);

    for(let r=1; r<=zoneCfg.rows; r++){
      const key = currentZone + col + "-" + r;
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.textContent = r;

      const occupied = Object.values(assigned)
        .some(a => isOrderInCurrentLocation(a) && a.place === key);

      if(occupied){
        cell.classList.add("occupied");
      }

      if(selectedCell === key){
        cell.classList.add("pending");
      }

      cell.onclick = () => {

        // TRYB PRZYPISANIA
        if(currentOrder){
          if(!canAssignToGridCell(key, currentOrder)){
            alert("‚ùå Na jednej palecie mogƒÖ byƒá tylko podzlecenia tej samej rodziny");
            return;
          }

          selectedCell = key;
          renderGrid();
          return;
        }

        // PODGLƒÑD
        if(occupied){
          const list = Object.entries(assigned)
            .filter(([_,a]) =>
              isOrderInCurrentLocation(a) && a.place === key
            )
            .map(([o]) => o);

          alert(
            list.length
              ? `Zlecenia w polu ${key}:\n\n${list.join("\n")}`
              : `Brak zlece≈Ñ`
          );
        }
      };

      cd.appendChild(cell);
    }

    g.appendChild(cd);
  }

  c.appendChild(g);
}

async function assignLocation(){
  if(!currentOrder){
    alert("Brak zlecenia");
    return;
  }

  if(!selectedCell){
    alert("Nie wybrano miejsca ani maszyny");
    return;
  }

  // üîç zapamiƒôtaj poprzedniƒÖ lokalizacjƒô (je≈õli by≈Ça)
  const previous = assigned[currentOrder]
    ? `${assigned[currentOrder].location} / ${assigned[currentOrder].place}`
    : null;

  const payload = {
    order_id: currentOrder,
    location: currentLocation,
    place: selectedCell,
    user_id: currentUser.id
  };

  try{
    const res = await fetch(`${API_URL}/api/assign`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      alert("B≈ÇƒÖd zapisu do backendu");
      return;
    }

    console.log("‚úÖ Zapisano w backendzie:", payload);

    const newPlace =
      selectedCell.startsWith("MASZYNA-")
        ? `maszynƒô ${selectedCell.replace("MASZYNA-", "")}`
        : `${currentLocation} / ${selectedCell}`;

    if(previous){
      alert(
        `‚úÖ Zlecenie ${payload.order_id} przeniesiono\n` +
        `z: ${previous}\n` +
        `do: ${newPlace}`
      );
    }else{
      alert(
        `‚úÖ Zlecenie ${payload.order_id} przypisano do:\n${newPlace}`
      );
    }

    // reset UI
    currentOrder = null;
    currentMachine = null;
    selectedCell = null;

    document.getElementById("current-order").textContent = "‚Äì";
    document.getElementById("current-machine").textContent = "‚Äì";

    // üîÑ JEDYNE ≈πR√ìD≈ÅO PRAWDY
    await loadHistory();
    rebuildHighlightsForCurrentLocation();
    renderGrid();

  }catch(err){
    console.error("‚ùå B≈ÇƒÖd zapisu:", err);
    alert("B≈ÇƒÖd po≈ÇƒÖczenia z backendem");
  }
}

function searchOrder(){
  const q = document.getElementById("searchInput").value.trim().toUpperCase();
  const box = document.getElementById("search-results");
  box.innerHTML = "";

  if(!q) return;

  const results = Object.entries(assigned)
    .filter(([order]) =>
      order.toUpperCase().includes(q) ||
      getFamily(order).toUpperCase().includes(q)
    );

  if(!results.length){
    box.innerHTML = "<div>Brak wynik√≥w</div>";
    return;
  }

  results.forEach(([order, a])=>{
    const d = document.createElement("div");
    d.textContent = `${order} ‚Üí ${a.location} / ${a.place}`;
    box.appendChild(d);
  });
}

function clearSearch(){
  document.getElementById("searchInput").value = "";
  document.getElementById("search-results").innerHTML = "";
}

// =====================
// GLOBAL SEARCH (START SCREEN)
// =====================

function globalSearch(){
  const q = document.getElementById("globalSearchInput").value.trim().toUpperCase();
  const box = document.getElementById("global-search-results");
  box.innerHTML = "";

  if(!q) return;

  const results = Object.entries(assigned)
    .filter(([order]) =>
      order.toUpperCase().includes(q) ||
      getFamily(order).toUpperCase().includes(q)
    );

  if(!results.length){
    box.innerHTML = "<div>Brak wynik√≥w</div>";
    return;
  }

  results.forEach(([order, a])=>{
    const d = document.createElement("div");
    d.textContent = `${order} ‚Üí ${a.location} / ${a.place}`;
    box.appendChild(d);
  });
}

function clearGlobalSearch(){
  document.getElementById("globalSearchInput").value = "";
  document.getElementById("global-search-results").innerHTML = "";
}

function downloadHistoryCSV(){
  window.location.href = API_URL + "/api/export/history.csv";
}

async function logout(){
  if(currentUser){
    try{
      await fetch(`${API_URL}/api/login_event`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: currentUser.id,
          action: "LOGOUT"
        })
      });
    }catch(err){
      console.error("‚ùå B≈ÇƒÖd zapisu LOGOUT:", err);
    }
  }

  currentUser = null;
  updateAuthUI();
  alert("üëã Wylogowano");
}

async function handleLogin(){
  const user = document.getElementById("loginUser").value.trim();
  const pass = document.getElementById("loginPass").value.trim();
  const errorBox = document.getElementById("login-error");

  errorBox.textContent = "";

  if(!user || !pass){
    errorBox.textContent = "Podaj symbol i has≈Ço";
    return;
  }

  try{
    const res = await fetch(API_URL + "/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username: user,
        password: pass
      })
    });

    const data = await res.json();

    if(!res.ok){
      errorBox.textContent = data.error || "B≈ÇƒÖd logowania";
      return;
    }

    // ‚úÖ TU JEDYNE USTAWIENIE currentUser
    currentUser = {
      id: data.user_id,
      username: data.username,
      role: data.role   // ‚¨ÖÔ∏è TO JEST KLUCZOWE
    };

    alert(`‚úÖ Zalogowano: ${currentUser.username}`);

    // üì° log do backendu
    try{
      fetch(`${API_URL}/api/login_event`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: currentUser.id,
        action: "LOGIN"
      })
    });
  }catch(e){
    console.warn("‚ö†Ô∏è Nie zapisano LOGIN do historii");
  }

    console.log("‚úÖ Zalogowano:", currentUser);

    // ‚úÖ JEDYNE sterowanie widokiem
    updateAuthUI();

  }catch(err){
    // ‚ùó TO ZOSTAJE
    console.error(err);
    errorBox.textContent = "B≈ÇƒÖd po≈ÇƒÖczenia z serwerem";
  }
}

function toggleAdminPanel(){
  const panel = document.getElementById("admin-panel");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}

function toggleProcessPanel(){
  const panel = document.getElementById("process-panel");
  panel.style.display = panel.style.display === "none"
    ? "block"
    : "none";
}

function updateAuthUI(){
  const loggedIn = !!currentUser;
  const isAdmin = loggedIn && currentUser.username === "admin";

  document.getElementById("login-screen").style.display =
    loggedIn ? "none" : "flex";

  document.getElementById("location-screen").style.display =
    loggedIn ? "flex" : "none";

  document.getElementById("top-auth-bar").style.display =
    loggedIn ? "block" : "none";

  document.getElementById("admin-entry").style.display =
    isAdmin ? "block" : "none";

  document.getElementById("admin-panel").style.display = "none";

  // üî• ZAWSZE ukrywamy panel procesu tutaj
  document.getElementById("process-wrapper").style.display = "none";
}

//  TO jest klucz // 
updateAuthUI();

// =====================
// PANEL OPERATORA ‚Äì ZMIANA STANU
// =====================

async function confirmProcessStatus(){
  const order  = document.getElementById("processOrder").value.trim();
  const status = parseInt(
    document.getElementById("processStatus").value
  );

  if(!order){
    alert("Podaj numer zlecenia");
    return;
  }

  if(!confirm(`Czy na pewno zmieniƒá stan zlecenia ${order}?`)){
    return;
  }

  const PROCESS_MAP = {
    operator_kolbus: "KOLBUS",
    operator_da: "DA",
    operator_diamant: "DIAMANT"
  };

  let processName = PROCESS_MAP[currentUser.role];

  // üëë ADMIN ‚Äì tymczasowo traktujemy jak DA
  if(currentUser.role === "admin"){
    processName = "DA";
  }

  if(!processName){
    alert("‚ùå Brak przypisanego procesu do tej roli");
    return;
  }

  try{
    const res = await fetch(
      API_URL + "/api/process/status",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          order_id: order,
          process: processName,
          status: status,
          user_id: currentUser.id
        })
      }
    );

    if(!res.ok){
      const error = await res.json();
      alert("‚ùå " + (error.error || "B≈ÇƒÖd zapisu stanu"));
      return;
    }

    alert("‚úÖ Stan procesu zapisany");
    document.getElementById("processOrder").value = "";

    // üîÑ OD≈öWIE≈ª STAN Z BACKENDU
    await loadHistory();
    rebuildHighlightsForCurrentLocation();
    renderGrid(); 

  }catch(err){
    console.error(err);
    alert("‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z serwerem");
  }
}

async function manualRemoveFromMachine(){
  const order = document.getElementById("processOrder").value.trim();

  if(!order){
    alert("Podaj numer zlecenia");
    return;
  }

  if(!confirm(`Czy na pewno wyprowadziƒá ${order} z maszyny?`)){
    return;
  }

  try{
    const res = await fetch(
      API_URL + "/api/process/manual_remove",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          order_id: order,
          user_id: currentUser.id
        })
      }
    );

    if(!res.ok){
      alert("‚ùå B≈ÇƒÖd usuwania");
      return;
    }

    alert("‚úÖ Wyprowadzono z maszyny");

    await loadHistory();
    rebuildHighlightsForCurrentLocation();
    renderGrid();

  }catch(err){
    console.error(err);
    alert("‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z serwerem");
  }
}

async function loadAdminUsers(){
  const box = document.getElementById("admin-users-list");
  box.style.display = "block";
  box.innerHTML = "‚è≥ ≈Åadowanie...";

  try{
    const res = await fetch(API_URL + "/api/admin/users");
    const users = await res.json();

    box.innerHTML = "";

    users.forEach(u => {
      const row = document.createElement("div");
      row.style.padding = "12px 0";
      row.style.borderBottom = "1px solid #eee";
      row.style.display = "flex";
      row.style.flexDirection = "column";
      row.style.gap = "8px";

      row.innerHTML = `
        <strong>${u.username}</strong>
        <small>
          ID: ${u.id} |
          Status: ${u.is_active ? "AKTYWNY" : "ZABLOKOWANY"}
        </small>

        ${
          u.username === "admin"
            ? `<strong>Rola: ADMIN</strong>`
            : `
              <label>
                Rola:
                <select onchange="changeUserRole(${u.id}, this.value)">
                  <option value="pracownik" ${u.role==="pracownik"?"selected":""}>Pracownik</option>
                  <option value="operator" ${u.role==="operator"?"selected":""}>Operator</option>
                  <option value="operator_kolbus" ${u.role==="operator_kolbus"?"selected":""}>Operator KOLBUS</option>
                  <option value="operator_da" ${u.role==="operator_da"?"selected":""}>Operator DA</option>
                  <option value="operator_diamant" ${u.role==="operator_diamant"?"selected":""}>Operator DIAMANT</option>
                  <option value="mleczarz" ${u.role==="mleczarz"?"selected":""}>Mleczarz</option>
                  <option value="magazynier" ${u.role==="magazynier"?"selected":""}>Magazynier</option>
                  <option value="kierowca" ${u.role==="kierowca"?"selected":""}>Kierowca</option>
                </select>
              </label>
            `
        }

        ${
          u.username !== "admin"
            ? `
              <div style="display:flex; gap:8px">
                <button
                  style="font-size:13px"
                  onclick="resetUserPassword(${u.id})"
                >
                  üîë Reset has≈Ça
                </button>
                <button
                  style="font-size:13px;background:#c0392b"
                  onclick="disableUser(${u.id})"
                >
                  üóë Usu≈Ñ
                </button>
              </div>
            `
            : ""
        }
      `;

      box.appendChild(row);
    });

  }catch(err){
    box.innerHTML = "‚ùå B≈ÇƒÖd pobierania u≈ºytkownik√≥w";
    console.error(err);
  }
}


async function adminCreateUser(){
  const login = document.getElementById("newUserLogin").value.trim();
  const pass  = document.getElementById("newUserPass").value.trim();
  const role  = document.getElementById("newUserRole").value;
  const msg   = document.getElementById("admin-msg");

  msg.textContent = "";

  if(!login || !pass){
    msg.textContent = "Podaj login i has≈Ço";
    return;
  }

  try{
    const res = await fetch(`${API_URL}/api/admin/users`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username: login,
        password: pass,
        role: role
      })
    });

    const data = await res.json();

    if(!res.ok){
      msg.textContent = data.error || "B≈ÇƒÖd";
      return;
    }

    msg.textContent = "‚úÖ U≈ºytkownik dodany";
    document.getElementById("newUserLogin").value = "";
    document.getElementById("newUserPass").value = "";

    loadAdminUsers(); // od≈õwie≈º listƒô

  }catch(e){
    msg.textContent = "‚ùå B≈ÇƒÖd po≈ÇƒÖczenia";
  }
}

async function resetUserPassword(userId){
  const newPass = prompt("Podaj nowe has≈Ço:");

  if(!newPass) return;

  try{
    const res = await fetch(
      `${API_URL}/api/admin/users/${userId}/reset_password`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: newPass })
      }
    );

    const data = await res.json();

    if(!res.ok){
      alert(data.error || "B≈ÇƒÖd resetu has≈Ça");
      return;
    }

    alert("‚úÖ Has≈Ço zresetowane");

  }catch(e){
    alert("‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z backendem");
  }
}

function toggleUsersList(){
  const box = document.getElementById("admin-users-list");

  if(box.style.display === "block"){
    box.style.display = "none";
    box.innerHTML = "";
    return;
  }

  loadAdminUsers();
}

async function changeUserRole(userId, role){
  if(!confirm("Czy na pewno zmieniƒá rolƒô u≈ºytkownika?")) return;

  try{
    const res = await fetch(
      `${API_URL}/api/admin/users/${userId}/role`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ role })
      }
    );

    const data = await res.json();

    if(!res.ok){
      alert(data.error || "B≈ÇƒÖd zmiany roli");
      return;
    }

    alert("‚úÖ Rola zmieniona");
  }catch(e){
    alert("‚ùå B≈ÇƒÖd po≈ÇƒÖczenia");
  }
}

</script>

</body>
</html>
